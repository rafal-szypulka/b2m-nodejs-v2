



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://rafal-szypulka.github.io/b2m-nodejs-v2/logging/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.2.0">
    
    
      
        <title>2. Node.js Logging - Build to Manage - Node.js Observability</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.572ca0f0.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.8c900955.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#logging" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://rafal-szypulka.github.io/b2m-nodejs-v2/" title="Build to Manage - Node.js Observability" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Build to Manage - Node.js Observability
              </span>
              <span class="md-header-nav__topic">
                2. Node.js Logging
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/rafal-szypulka/b2m-nodejs-v2/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://rafal-szypulka.github.io/b2m-nodejs-v2/" title="Build to Manage - Node.js Observability" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Build to Manage - Node.js Observability
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/rafal-szypulka/b2m-nodejs-v2/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="1. Introduction" class="md-nav__link">
      1. Introduction
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        2. Node.js Logging
      </label>
    
    <a href="./" title="2. Node.js Logging" class="md-nav__link md-nav__link--active">
      2. Node.js Logging
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lab-1-nodejs-app-logging-with-elastic-stack" title="Lab 1 - Node.js app logging with Elastic stack" class="md-nav__link">
    Lab 1 - Node.js app logging with Elastic stack
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-a-local-elastic-stack-with-docker-compose" title="Deploy a local Elastic stack with Docker Compose" class="md-nav__link">
    Deploy a local Elastic stack with Docker Compose
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instrument-the-nodejs-app-with-logging" title="Instrument the Node.js app with logging" class="md-nav__link">
    Instrument the Node.js app with logging
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-2-nodejs-app-logging-with-humio" title="Lab 2 - Node.js app logging with Humio" class="md-nav__link">
    Lab 2 - Node.js app logging with Humio
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instrument-the-nodejs-app-with-logging_1" title="Instrument the Node.js app with logging" class="md-nav__link">
    Instrument the Node.js app with logging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-humio-with-docker-compose" title="Deploy Humio with Docker Compose" class="md-nav__link">
    Deploy Humio with Docker Compose
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../monitoring-instrumentation/" title="4. Node.js Monitoring" class="md-nav__link">
      4. Node.js Monitoring
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Prometheus-Grafana/" title="5. Prometheus and Grafana configuration" class="md-nav__link">
      5. Prometheus and Grafana configuration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../OCP/" title="6. Deploy to RedHat OpenShift 4.2" class="md-nav__link">
      6. Deploy to RedHat OpenShift 4.2
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/learning-distributed-tracing-101/docs/lab-jaeger-nodejs.html" title="Test" class="md-nav__link">
      Test
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lab-1-nodejs-app-logging-with-elastic-stack" title="Lab 1 - Node.js app logging with Elastic stack" class="md-nav__link">
    Lab 1 - Node.js app logging with Elastic stack
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-a-local-elastic-stack-with-docker-compose" title="Deploy a local Elastic stack with Docker Compose" class="md-nav__link">
    Deploy a local Elastic stack with Docker Compose
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instrument-the-nodejs-app-with-logging" title="Instrument the Node.js app with logging" class="md-nav__link">
    Instrument the Node.js app with logging
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-2-nodejs-app-logging-with-humio" title="Lab 2 - Node.js app logging with Humio" class="md-nav__link">
    Lab 2 - Node.js app logging with Humio
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instrument-the-nodejs-app-with-logging_1" title="Instrument the Node.js app with logging" class="md-nav__link">
    Instrument the Node.js app with logging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-humio-with-docker-compose" title="Deploy Humio with Docker Compose" class="md-nav__link">
    Deploy Humio with Docker Compose
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/rafal-szypulka/b2m-nodejs-v2/edit/master/docs/logging.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="logging">Logging<a class="headerlink" href="#logging" title="Permanent link">&para;</a></h1>
<ul>
<li><a href="#logging">Logging</a></li>
<li><a href="#lab-1---nodejs-app-logging-with-elastic-stack">Lab 1 - Node.js app logging with Elastic stack</a><ul>
<li><a href="#deploy-a-local-elastic-stack-with-docker-compose">Deploy a local Elastic stack with Docker Compose</a></li>
<li><a href="#instrument-the-nodejs-app-with-logging">Instrument the Node.js app with logging</a></li>
</ul>
</li>
<li><a href="#lab-2---nodejs-app-logging-with-humio">Lab 2 - Node.js app logging with Humio</a><ul>
<li><a href="#instrument-the-nodejs-app-with-logging-1">Instrument the Node.js app with logging</a></li>
<li><a href="#deploy-humio-with-docker-compose">Deploy Humio with Docker Compose</a></li>
</ul>
</li>
</ul>
<p>A production service should have both logging and monitoring. Monitoring provides a real-time and historical view on the system and application state, and alerts you in case a situation is met. In most cases, a monitoring alert is simply a trigger for you to start an investigation. Monitoring shows the symptoms of problems. Logs provide details and state on individual transactions, so you can fully understand the cause of problems.</p>
<p>Logs provide visibility into the behavior of a running app, they are one of the most fundamental tools for debugging and finding issues within your application. If structured correctly, logs can contain a wealth of information about a specific event. Logs can tell us not only when the event took place, but also provide us with details as to the root cause. Therefore, it is important that the log entries are readable to humans and machines. </p>
<p>According to the <a href="https://12factor.net/">12-factor</a> application guidelines, logs are the stream of aggregated, time-ordered events. A twelve-factor app never concerns itself with routing or storage of its output stream. It should not attempt to write to or manage log files. Instead, each running process writes its event stream, unbuffered, to stdout. If you deviate from these guidelines, make sure that you address the operational needs for log files, such as logging to local files and applying log rotation policies.</p>
<h2 id="lab-1-nodejs-app-logging-with-elastic-stack">Lab 1 - Node.js app logging with Elastic stack<a class="headerlink" href="#lab-1-nodejs-app-logging-with-elastic-stack" title="Permanent link">&para;</a></h2>
<h3 id="deploy-a-local-elastic-stack-with-docker-compose">Deploy a local Elastic stack with Docker Compose<a class="headerlink" href="#deploy-a-local-elastic-stack-with-docker-compose" title="Permanent link">&para;</a></h3>
<p>During this lab we will run the Elastic Stack (Elasticsearch, Logstash, Kibana) in docker-compose.
The ELK configuration in this lab is based on <a href="https://github.com/deviantony/docker-elk">https://github.com/deviantony/docker-elk</a> (6.8.x branch).</p>
<p>Briefly review the simple Logstash configuration we will use for this lab: <code>docker-elk/logstash/pipeline/logstash.conf</code>:</p>
<div class="codehilite"><pre><span></span>input {
    gelf { port =&gt; 5000 }
}

filter {
    json { source =&gt; &quot;message&quot; }
    #we need level field in a numeric format
    mutate {
     gsub =&gt; [
      &quot;level&quot;, &quot;info&quot;, 6,
      &quot;level&quot;, &quot;error&quot;, 3
     ]
    }
    mutate {
     convert =&gt; { &quot;level&quot; =&gt; &quot;integer&quot; }
    }
}

output {
    elasticsearch {
        hosts =&gt; &quot;elasticsearch:9200&quot;
        user =&gt; &quot;elastic&quot;
        password =&gt; &quot;changeme&quot;
    }
    stdout { codec =&gt; rubydebug }
}
</pre></div>


<p>The above will configure Logstash input to use <code>gelf</code> (Graylog Extended Log Format) protocol supported by Docker log driver, so we can directly stream application logs from the app running in Docker container to Logstash using <code>gelf</code> protocol. JSON formatted app log message is extracted from the field <code>message</code> and parsed to named fields. After parsing and conversion the log steam is sent to elasticsearch.</p>
<p>1). Start the Elastic stack:</p>
<div class="codehilite"><pre><span></span>cd b2m-nodejs-v2/lab-1/docker-elk
docker-compose build
docker-compose up -d
</pre></div>


<blockquote>
<p>Note, it may take a while for the first time, because it will download the ELK images from DockerHub and build an image for our Node.js application.</p>
</blockquote>
<p>2). While waiting for containers, review the configuration of our logging lab.
- <code>b2m-nodejs-v2/docker-elk/docker-compose.yaml</code> - this is the main config file for docker-compose stack which specifies all options for all containers in the stack.
- <code>b2m-nodejs-v2/lab-1/app/server.js</code> - the source code of our sample Node.js application.
- <code>b2m-nodejs-v2/lab-1/app/Dockerfile</code> - this file is used to build your app docker image.</p>
<p>3). After the <code>docker-compose</code> completed the startup, verify you can access Kibana on <code>http://localhost:5601</code>.</p>
<p>Logon using user: <code>elastic</code>, password: <code>changeme</code></p>
<p>4). <a href="https://www.elastic.co/guide/en/kibana/6.8/managing-saved-objects.html">Import</a> the index pattern, saved search, visualizations and dashboard from the provided <code>kibana.json</code> file. We will use them in the next part of the lab:
- Go to Management -&gt; Kibana/Saved Objects -&gt; Import and select the <code>b2m-nodejs-v2/kibana.json</code> file.</p>
<p>You should see the following Saved Objects imported:</p>
<p><img alt="" src="../images/2020-11-11-21-00-38.png" /></p>
<h3 id="instrument-the-nodejs-app-with-logging">Instrument the Node.js app with logging<a class="headerlink" href="#instrument-the-nodejs-app-with-logging" title="Permanent link">&para;</a></h3>
<p>Now we will configure a logging library for our Node.js app and add some log statements that will be easy to consume by the ELK stack.</p>
<p>1). Go to the directory <code>b2m-nodejs-v2/lab-1/app</code> where the <code>server.js</code> file is located and add the following dependency to the <code>package.json</code>:</p>
<div class="codehilite"><pre><span></span>    &quot;winston&quot;: &quot;^3.2.1&quot;
</pre></div>


<p>This will add <a href="https://www.npmjs.com/package/winston">winston</a> logging library for node.js.</p>
<p>2). Add/uncomment the following line at the beginning of <code>server.js</code> to load the <code>winston</code> module:</p>
<div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">createLogger</span><span class="p">,</span> <span class="nx">format</span><span class="p">,</span> <span class="nx">transports</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;winston&#39;</span><span class="p">)</span>
</pre></div>


<p>then create/uncomment the <code>logger</code> object:</p>
<div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">createLogger</span><span class="p">({</span>
  <span class="nx">level</span><span class="o">:</span> <span class="s1">&#39;debug&#39;</span><span class="p">,</span>
  <span class="nx">format</span><span class="o">:</span> <span class="nx">format</span><span class="p">.</span><span class="nx">combine</span><span class="p">(</span>
    <span class="nx">format</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">({</span>
      <span class="nx">format</span><span class="o">:</span> <span class="s2">&quot;YYYY-MM-DD&#39;T&#39;HH:mm:ss.SSSZ&quot;</span>
    <span class="p">}),</span>
    <span class="nx">format</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span>
  <span class="p">),</span>
  <span class="nx">transports</span><span class="o">:</span> <span class="p">[</span><span class="k">new</span> <span class="nx">transports</span><span class="p">.</span><span class="nx">Console</span><span class="p">()]</span>
<span class="p">});</span>
</pre></div>


<p>The configuration above specifies timestamp field format and enables sending logs in <code>json</code> format to STDOUT.
Timestamp should include the time zone information and be precise down to milliseconds. </p>
<p>Whenever you want to generate a log entry, just use the <code>logger</code> object with level specified methods: <strong>error</strong>, <strong>warn</strong>, <strong>info</strong>, <strong>verbose</strong>, <strong>debug</strong></p>
<div class="codehilite"><pre><span></span><span class="nx">msg</span> <span class="o">=</span> <span class="s1">&#39;RSAP0010E: Severe problem detected&#39;</span>
<span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
<span class="nx">msg</span> <span class="o">=</span> <span class="s1">&#39;RSAP0001I: Transaction OK&#39;</span>
<span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
</pre></div>


<p>You can add also additional metadata like <code>errorCode</code> or <code>transactionTime</code> that can be useful in log analytics.</p>
<p>3). Add some logging statements as described below. Additional metadata will be used later in our log analytics dashboard. </p>
<p>Look for commented lines starting with <code>logger</code> and uncomment them.</p>
<div class="codehilite"><pre><span></span><span class="nx">msg</span> <span class="o">=</span> <span class="s1">&#39;RSAP0001I: Transaction OK&#39;</span>
<span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;errCode&quot;</span><span class="o">:</span> <span class="s2">&quot;RSAP0001I&quot;</span><span class="p">,</span> <span class="s2">&quot;transactionTime&quot;</span><span class="o">:</span> <span class="nx">delay</span><span class="p">})</span>

<span class="nx">msg</span> <span class="o">=</span> <span class="s1">&#39;RSAP0010E: Severe problem detected&#39;</span>
<span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;errorCode&quot;</span><span class="o">:</span> <span class="s2">&quot;RSAP0010E&quot;</span><span class="p">,</span> <span class="s2">&quot;transactionTime&quot;</span><span class="o">:</span> <span class="nx">delay</span><span class="p">})</span>
</pre></div>


<p>After these changes the expected STDOUT is:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span><span class="nt">&quot;errCode&quot;</span><span class="p">:</span><span class="s2">&quot;RSAP0001I&quot;</span><span class="p">,</span><span class="nt">&quot;transactionTime&quot;</span><span class="p">:</span><span class="mi">81</span><span class="p">,</span><span class="nt">&quot;level&quot;</span><span class="p">:</span><span class="s2">&quot;info&quot;</span><span class="p">,</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;RSAP0001I: Transaction OK&quot;</span><span class="p">,</span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="s2">&quot;2019-02-27T07:34:49.625Z&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;errCode&quot;</span><span class="p">:</span><span class="s2">&quot;RSAP0010E&quot;</span><span class="p">,</span><span class="nt">&quot;transactionTime&quot;</span><span class="p">:</span><span class="mi">76</span><span class="p">,</span><span class="nt">&quot;level&quot;</span><span class="p">:</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;RSAP0010E: Severe problem detected&quot;</span><span class="p">,</span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="s2">&quot;2019-02-27T07:34:50.008Z&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;errCode&quot;</span><span class="p">:</span><span class="s2">&quot;RSAP0001I&quot;</span><span class="p">,</span><span class="nt">&quot;transactionTime&quot;</span><span class="p">:</span><span class="mi">22</span><span class="p">,</span><span class="nt">&quot;level&quot;</span><span class="p">:</span><span class="s2">&quot;info&quot;</span><span class="p">,</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;RSAP0001I: Transaction OK&quot;</span><span class="p">,</span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="s2">&quot;2019-02-27T07:34:50.325Z&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;errCode&quot;</span><span class="p">:</span><span class="s2">&quot;RSAP0001I&quot;</span><span class="p">,</span><span class="nt">&quot;transactionTime&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nt">&quot;level&quot;</span><span class="p">:</span><span class="s2">&quot;info&quot;</span><span class="p">,</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;RSAP0001I: Transaction OK&quot;</span><span class="p">,</span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="s2">&quot;2019-02-27T07:34:50.620Z&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;errCode&quot;</span><span class="p">:</span><span class="s2">&quot;RSAP0001I&quot;</span><span class="p">,</span><span class="nt">&quot;transactionTime&quot;</span><span class="p">:</span><span class="mi">96</span><span class="p">,</span><span class="nt">&quot;level&quot;</span><span class="p">:</span><span class="s2">&quot;info&quot;</span><span class="p">,</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;RSAP0001I: Transaction OK&quot;</span><span class="p">,</span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="s2">&quot;2019-02-27T07:34:50.871Z&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&quot;errCode&quot;</span><span class="p">:</span><span class="s2">&quot;RSAP0001I&quot;</span><span class="p">,</span><span class="nt">&quot;transactionTime&quot;</span><span class="p">:</span><span class="mi">62</span><span class="p">,</span><span class="nt">&quot;level&quot;</span><span class="p">:</span><span class="s2">&quot;info&quot;</span><span class="p">,</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;RSAP0001I: Transaction OK&quot;</span><span class="p">,</span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="s2">&quot;2019-02-27T07:34:51.156Z&quot;</span><span class="p">}</span>
</pre></div>


<p>3). Rebuild the Node.js app contaner:</p>
<div class="codehilite"><pre><span></span>cd b2m-nodejs-v2/lab-1
docker-compose down
docker-compose build
docker-compose up -d
</pre></div>


<p>4). Simulate a couple of transactions using your web browser or <code>curl</code> by accessing <code>http://localhost:3001/checkout</code>:</p>
<div class="codehilite"><pre><span></span>for i in {1..10000}; do curl -w &quot;\n&quot; http://localhost:3001/checkout; done
</pre></div>


<p>and check out the Kibana (http://localhost:5601 elastic/changeme):
- The <strong>Discover</strong> view should be similar to:</p>
<p><img alt="" src="../images/2020-11-11-21-11-06.png" />
- From the upper menu select <code>Open</code> and select the preconfigured saved search <code>btm-nodejs</code>:</p>
<p><img alt="" src="../images/2020-11-11-21-12-28.png" /></p>
<ul>
<li>Access Dashboards -&gt; <code>BTM Node.js</code>:</li>
</ul>
<p><img alt="" src="../images/2020-11-11-21-20-21.png" /></p>
<p>Kibana Dashboard is a collection of <strong>Visualizations</strong>. If you are interested in how these charts are configured, select the <strong>Visualize</strong> on the left menu, then select one of the Visualizations and check its configuration.</p>
<blockquote>
<p><strong>Stop the docker-compose stack before starting the next exercise:</strong></p>
</blockquote>
<div class="codehilite"><pre><span></span>cd b2m-nodejs-v2/lab-1/docker-elk
docker-compose down -v
</pre></div>


<h2 id="lab-2-nodejs-app-logging-with-humio">Lab 2 - Node.js app logging with Humio<a class="headerlink" href="#lab-2-nodejs-app-logging-with-humio" title="Permanent link">&para;</a></h2>
<p><a href="https://humio.com">Humio</a> is purpose-built to help any organization achieve the benefits of large-scale logging and analysis. Humio has virtually no latency even at massive ingest volumes. And by using cloud-based bucket storage for all persistent data, retention is virtually infinite.
Humio aggregates, alerts, and visualizes streaming data in real time, so no matter what volume of data you send to Humio, data is processed instantly. This gives organizations live observability into the operations and health of their systems.
Indexing can be a very computationally-expensive activity, causing latency between data entering a system and then being included in search results and visualizations. Humio does no indexing, so it remains lightning fast with no compromise on performance.
Free-text search lets you search anything, in any field, without relying on pre-parsed fields. Schema on read allows you to extract data, define new fields, and use them to filter and aggregate as you search — all at blazing speeds.
Humio uses high data compression so you can cut hardware costs and store more data. High compression also makes it cost-effective to retain more data for longer, enabling both more detailed analysis and traceability over longer time periods.</p>
<p>More on https://www.humio.com/log-management#features</p>
<h3 id="instrument-the-nodejs-app-with-logging_1">Instrument the Node.js app with logging<a class="headerlink" href="#instrument-the-nodejs-app-with-logging_1" title="Permanent link">&para;</a></h3>
<p>If you did the Lab 1, you don't have to do anything - we will use exactly the same instrumentation, just copy and replace the <code>b2m-nodejs-v2/lab-1/app/server.js</code> to <code>b2m-nodejs-v2/lab-2/app/server.js</code>.</p>
<p>If you start with Lab 2, do the instrumentation steps with <code>winston</code> logging library as described in chapter <a href="#instrument-the-nodejs-app-with-logging">Instrument the Node.js app with logging</a>.</p>
<h3 id="deploy-humio-with-docker-compose">Deploy Humio with Docker Compose<a class="headerlink" href="#deploy-humio-with-docker-compose" title="Permanent link">&para;</a></h3>
<p>Start Humio with our Node.js app in docker-compose:</p>
<div class="codehilite"><pre><span></span>cd b2m-nodejs-v2/lab-2
./start-lab2.sh
</pre></div>


<blockquote>
<p>Note, it may take a while for the first time, because it will download the Humio image from DockerHub.</p>
</blockquote>
<p>While waiting for containers, review the configuration of our logging lab.</p>
<ul>
<li><code>b2m-nodejs-v2/lab-2/docker-compose.yaml</code> - this is the main config file for docker-compose stack which specifies all options for all containers in the stack.</li>
<li><code>b2m-nodejs-v2/lab-2/app/server.js</code> - the source code of our sample Node.js application instrumented with logging.</li>
<li><code>b2m-nodejs-v2/lab-2/app/Dockerfile</code> - this file is used to build your app docker image.</li>
</ul>
<p>Access the Humio UI using internet browser on http://localhost:8080
Click <code>Add item</code> and create <code>b2m-nodejs</code> repository.
Click on the new repository link and go to <code>Settings -&gt; API Tokens</code>. Copy the default token.</p>
<p>Stop the Humio stack:</p>
<div class="codehilite"><pre><span></span>cd b2m-nodejs-v2/lab-2
docker-compose down
</pre></div>


<p>Edit the <code>b2m-nodejs-v2/lab-2/docker-compose.yaml</code> and paste the token as value of <code>splunk-token</code> (remember to put the token in quotes).
Uncomment the whole <code>b2m-nodejs</code> section (together with all its options).</p>
<p>Start the Humio and Node.js stack:</p>
<div class="codehilite"><pre><span></span>cd b2m-nodejs-v2/lab-2
./start-lab2.sh
</pre></div>


<p>Access the Humio UI using internet browser on http://localhost:8080</p>
<p>Go to <code>b2m-nodejs</code> repository and select <code>Parsers</code>:</p>
<p>Click on <code>+ New Parser</code>. Name it <code>b2m-json</code>.</p>
<p>Paste the following Parser script:</p>
<div class="codehilite"><pre><span></span>parseJson()|parseJson(line)
</pre></div>


<p>Why we parse JSON twice? Docker wraps the application log (which we emit as JSON) in its own JSON envelope, so first we parse docker JSON and then pare JSON contents of already extracted field <code>line</code>. Note the cool <code>|</code> characted which works exactly the same way as in Linux or Unix shell.</p>
<p>On the right side of the Parsers editor you can test your parser. Paste this line:</p>
<div class="codehilite"><pre><span></span>{&quot;line&quot;:&quot;{\&quot;errCode\&quot;:\&quot;RSAP0001I\&quot;,\&quot;transactionTime\&quot;:43,\&quot;level\&quot;:\&quot;info\&quot;,\&quot;message\&quot;:\&quot;RSAP0001I: Transaction OK\&quot;,\&quot;timestamp\&quot;:\&quot;2020-11-11T22:35:20.949Z\&quot;}&quot;,&quot;source&quot;:&quot;stdout&quot;,&quot;tag&quot;:&quot;ee4799aa3c53&quot;}
</pre></div>


<p>and verify extracted fileds.</p>
<p>Save your new Parser.</p>
<p>Go to Settings-&gt;API tokens and select your newly defined parse in the <code>Assigned Parser</code> option of the <code>default</code> API token.</p>
<p>Simulate a couple of transactions using your web browser or <code>curl</code> by accessing http://localhost:3001/checkout:</p>
<div class="codehilite"><pre><span></span>for i in {1..10000}; do curl -w &quot;\n&quot; http://localhost:3001/checkout; done
</pre></div>


<p>Verify results in the Search view.</p>
<p>Import the Humio dashboard provided with this lab <code>humio-dashboard.yaml</code>:
- Go to <code>Dashboards</code>, click <code>+ New Dashboard</code>
- Select <code>Template file</code> Option and name it <code>B2M Node.js</code>
- Click <code>Upload Template</code> and select <code>b2m-nodejs-v2/lab-2/humio-dashboard.yaml</code>
- Click <code>Create Dashboard</code></p>
<p>Access <code>B2M Node.js</code> dashboard. Generate more application requests with:</p>
<div class="codehilite"><pre><span></span>for i in {1..10000}; do curl -w &quot;\n&quot; http://localhost:3001/checkout; done
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href=".." title="1. Introduction" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                1. Introduction
              </span>
            </div>
          </a>
        
        
          <a href="../monitoring-instrumentation/" title="4. Node.js Monitoring" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                4. Node.js Monitoring
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b41f3d20.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>