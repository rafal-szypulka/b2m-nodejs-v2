



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://rafal-szypulka.github.io/b2m-nodejs-v2/OCP/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.2.0">
    
    
      
        <title>4. App monitoring on Openshift - Build to Manage - Node.js Observability</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.572ca0f0.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.8c900955.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#how-to-monitor-applications-on-openshift-4x-with-prometheus-operator" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://rafal-szypulka.github.io/b2m-nodejs-v2/" title="Build to Manage - Node.js Observability" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Build to Manage - Node.js Observability
              </span>
              <span class="md-header-nav__topic">
                4. App monitoring on Openshift
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/rafal-szypulka/b2m-nodejs-v2/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://rafal-szypulka.github.io/b2m-nodejs-v2/" title="Build to Manage - Node.js Observability" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Build to Manage - Node.js Observability
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/rafal-szypulka/b2m-nodejs-v2/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="1. Introduction" class="md-nav__link">
      1. Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../logging/" title="2. Node.js Logging" class="md-nav__link">
      2. Node.js Logging
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../monitoring/" title="3. Node.js Monitoring" class="md-nav__link">
      3. Node.js Monitoring
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        4. App monitoring on Openshift
      </label>
    
    <a href="./" title="4. App monitoring on Openshift" class="md-nav__link md-nav__link--active">
      4. App monitoring on Openshift
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-to-monitor-applications-on-openshift-4x-with-prometheus-operator" title="How to monitor applications on OpenShift 4.x with Prometheus Operator" class="md-nav__link">
    How to monitor applications on OpenShift 4.x with Prometheus Operator
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-an-instrumented-application" title="Deploy an instrumented application" class="md-nav__link">
    Deploy an instrumented application
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-prometheus-monitoring-stack-for-applications" title="Deploy Prometheus monitoring stack for applications." class="md-nav__link">
    Deploy Prometheus monitoring stack for applications.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-grafana-operator" title="Deploy Grafana Operator" class="md-nav__link">
    Deploy Grafana Operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-alertmanager" title="Deploy Alertmanager" class="md-nav__link">
    Deploy Alertmanager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-alerting-rules" title="Configure Alerting Rules" class="md-nav__link">
    Configure Alerting Rules
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/learning-distributed-tracing-101/docs/lab-jaeger-nodejs.html" title="5. Distributed Tracing labs" class="md-nav__link">
      5. Distributed Tracing labs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-to-monitor-applications-on-openshift-4x-with-prometheus-operator" title="How to monitor applications on OpenShift 4.x with Prometheus Operator" class="md-nav__link">
    How to monitor applications on OpenShift 4.x with Prometheus Operator
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-an-instrumented-application" title="Deploy an instrumented application" class="md-nav__link">
    Deploy an instrumented application
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-prometheus-monitoring-stack-for-applications" title="Deploy Prometheus monitoring stack for applications." class="md-nav__link">
    Deploy Prometheus monitoring stack for applications.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-grafana-operator" title="Deploy Grafana Operator" class="md-nav__link">
    Deploy Grafana Operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-alertmanager" title="Deploy Alertmanager" class="md-nav__link">
    Deploy Alertmanager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-alerting-rules" title="Configure Alerting Rules" class="md-nav__link">
    Configure Alerting Rules
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/rafal-szypulka/b2m-nodejs-v2/edit/master/docs/OCP.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>4. App monitoring on Openshift</h1>
                
                <h2 id="how-to-monitor-applications-on-openshift-4x-with-prometheus-operator">How to monitor applications on OpenShift 4.x with Prometheus Operator<a class="headerlink" href="#how-to-monitor-applications-on-openshift-4x-with-prometheus-operator" title="Permanent link">&para;</a></h2>
<p>OpenShift Container Platform includes a pre-configured, pre-installed, and self-updating monitoring stack that is based on the Prometheus open source project and its wider eco-system. It provides monitoring of cluster components and includes a set of alerts to immediately notify the cluster administrator about any occurring problems and a set of Grafana dashboards. The cluster monitoring stack is only supported for monitoring OpenShift Container Platform clusters and adding additional monitoring targets is not supported.</p>
<p>In this lab we will configure application monitoring stack on Openshift 4.x using Prometheus Operator for a sample Node.js microservice instrumented with Prometheus client library (instrumentation was covered in Lab-3).</p>
<h3 id="deploy-an-instrumented-application">Deploy an instrumented application<a class="headerlink" href="#deploy-an-instrumented-application" title="Permanent link">&para;</a></h3>
<p>Use the following command and provided yaml file, to deploy sample Node.js microservice instrumented with Prometheus client library. </p>
<div class="codehilite"><pre><span></span>oc new-project b2m-nodejs
oc new-app https://github.com/rafal-szypulka/b2m-nodejs-v2 --context-dir=lab-4/app --name b2m-nodejs --labels='name=b2m-nodejs' --insecure-registry=true</pre></div>

<p>The monitor expects the service's port name to be <B>web</B> so edit the service and change  spec -> ports -> name to web:</p>
<div class="codehilite"><pre><span></span>oc edit svc b2m-nodejs

  spec:
    clusterIP: xxx.xxx.xxx.xxx
    ports:
      - name: web

</pre></div>

<p>Create a route to expose this application externally:</p>
<div class="codehilite"><pre><span></span>oc expose svc b2m-nodejs
</pre></div>


<p>Collect the app URL:</p>
<div class="codehilite"><pre><span></span>$ oc get routes -n default
NAME         HOST/PORT                                       PATH   SERVICES     PORT    TERMINATION   WILDCARD
b2m-nodejs   b2m-nodejs-b2m-nodejs.apps.rsocp.os.fyre.ibm.com          b2m-nodejs   &lt;all&gt;   edge          None
</pre></div>


<p>and make sure it works:</p>
<div class="codehilite"><pre><span></span>$ curl -k https://b2m-nodejs-b2m-nodejs.apps.rsocp.os.fyre.ibm.com

<span class="o">{</span><span class="s2">&quot;status&quot;</span>:<span class="s2">&quot;ok&quot;</span>,<span class="s2">&quot;transactionTime&quot;</span>:<span class="s2">&quot;353ms&quot;</span><span class="o">}</span>
</pre></div>


<p>Verify that it properly exposes metrics in Prometheus format:</p>
<div class="codehilite"><pre><span></span>$ curl -k https://b2m-nodejs-b2m-nodejs.apps.rsocp.os.fyre.ibm.com/metrics

<span class="c1"># HELP process_cpu_user_seconds_total Total user CPU time spent in seconds.</span>
<span class="c1"># TYPE process_cpu_user_seconds_total counter</span>
process_cpu_user_seconds_total <span class="m">0</span>.23436700000000005 <span class="m">1573764470969</span>

<span class="c1"># HELP process_cpu_system_seconds_total Total system CPU time spent in seconds.</span>
<span class="c1"># TYPE process_cpu_system_seconds_total counter</span>
process_cpu_system_seconds_total <span class="m">0</span>.069524 <span class="m">1573764470969</span>

<span class="c1"># HELP process_cpu_seconds_total Total user and system CPU time spent in seconds.</span>
<span class="c1"># TYPE process_cpu_seconds_total counter</span>
process_cpu_seconds_total <span class="m">0</span>.3038910000000002 <span class="m">1573764470969</span>
<span class="o">(</span>...<span class="o">)</span>
</pre></div>


<h3 id="deploy-prometheus-monitoring-stack-for-applications">Deploy Prometheus monitoring stack for applications.<a class="headerlink" href="#deploy-prometheus-monitoring-stack-for-applications" title="Permanent link">&para;</a></h3>
<ol>
<li>Create a new project for the Prometheus monitoring stack for applications.</li>
</ol>
<p><img alt="" src="../images/2019-11-13-13-28-53.png" /></p>
<ol>
<li>Select Operators -&gt; Operator Hub and select <code>Prometheus Operator</code>. Click <code>Install</code>.</li>
</ol>
<p><img alt="" src="../images/2019-11-13-13-27-51.png" /></p>
<ol>
<li>In the <code>Create Operator Subscription</code> window click <code>Subscribe</code>.</li>
</ol>
<p><img alt="" src="../images/2019-11-13-13-44-07.png" /></p>
<ol>
<li>Wait until Prometheus Operator is deployed and click <code>Prometheus Operator</code> link.</li>
</ol>
<p><img alt="" src="../images/2019-11-13-13-44-44.png" /></p>
<ol>
<li>Select <code>Prometheus</code> tab and click <code>Create Prometheus</code> button.</li>
</ol>
<p><img alt="" src="../images/2019-11-13-13-45-19.png" /></p>
<ol>
<li>Modify default YAML template for Prometheus. I added <code>serviceMonitorSelector</code> definition which will instruct defined Prometheus instance to match <code>ServiceMonitors</code> with label <code>key=btm-metrics</code>. I also changed the Prometheus instance name to <code>app-monitor</code>.</li>
</ol>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">monitoring.coreos.com/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Prometheus</span>
<span class="nt">metadata</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">app-monitor</span>
<span class=" -Error">  </span><span class="nt">labels</span><span class="p">:</span>
    <span class="nt">prometheus</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">k8s</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">monitoring</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="nt">serviceAccountName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">prometheus-k8s</span>
  <span class="nt">securityContext</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
  <span class="nt">serviceMonitorSelector</span><span class="p">:</span>
    <span class="nt">matchExpressions</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">btm-metrics</span>
        <span class="nt">operator</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Exists</span>
  <span class="nt">ruleSelector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">prometheus</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">app-monitor</span>
      <span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">alert-rules</span>
  <span class="nt">alerting</span><span class="p">:</span>
    <span class="nt">alertmanagers</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
</pre></div>


<p>Click <code>Create</code> button.</p>
<p><img alt="" src="../images/2019-11-14-22-05-51.png" /></p>
<ol>
<li>Select <code>Service Monitor</code> tab and click <code>Create Service Monitor</code>.</li>
</ol>
<p><img alt="" src="../images/2019-11-13-13-46-31.png" /></p>
<ol>
<li>Modify default YAML template for ServiceMonitor. I added <code>namespaceSelector</code> definition to limit the scope to naespace <code>default</code> where my app has been deployed and modified <code>selector</code> that to look for services with label <code>name=b2m-nodejs</code>. I also changed the Service monitor name to <code>app-monitor</code>.</li>
</ol>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">monitoring.coreos.com/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ServiceMonitor</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">btm-metrics</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">b2m-nodejs</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">app-monitor</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">monitoring</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">endpoints</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">30s</span>
      <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
  <span class="nt">namespaceSelector</span><span class="p">:</span>
    <span class="nt">matchNames</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">b2m-nodejs</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">b2m-nodejs</span>
</pre></div>


<p><img alt="" src="../images/2019-11-13-13-49-32.png" /></p>
<ol>
<li>Grant <code>view</code> cluster role to the Service Account created by the operator and used by Prometheus.</li>
</ol>
<div class="codehilite"><pre><span></span>oc adm policy add-cluster-role-to-user view system:serviceaccount:monitoring:prometheus-k8s
</pre></div>


<p>or, if you want to limit it to the application namespace, add <code>view</code> role only to the app namespace:</p>
<div class="codehilite"><pre><span></span>oc adm policy add-role-to-user view system:serviceaccount:monitoring:prometheus-k8s -n default
</pre></div>


<ol>
<li>Expose app monitoring Prometheus route:</li>
</ol>
<div class="codehilite"><pre><span></span>oc expose svc/prometheus-operated -n monitoring
</pre></div>


<ol>
<li>Collect the app monitoring Prometheus URL:</li>
</ol>
<div class="codehilite"><pre><span></span>$ oc get routes -n monitoring
NAME                  HOST/PORT                                                   PATH   SERVICES              PORT   TERMINATION   WILDCARD
prometheus-operated   prometheus-operated-monitoring.apps.rsocp.os.fyre.ibm.com          prometheus-operated   web                  None
</pre></div>


<ol>
<li>Verify that app monitoring Prometheus can scrape <code>b2m-nodejs</code> app. Access the Prometheus URL via browser and select Status -&gt; Targets.</li>
</ol>
<p><img alt="" src="../images/2019-11-14-22-48-30.png" /></p>
<ol>
<li>Verify that instrumented metrics are collected:</li>
</ol>
<p><img alt="" src="../images/2019-11-14-22-51-10.png" /></p>
<h3 id="deploy-grafana-operator">Deploy Grafana Operator<a class="headerlink" href="#deploy-grafana-operator" title="Permanent link">&para;</a></h3>
<ol>
<li>Deploy the Grafana Operator from OperatorHub using the same steps as for Prometheus Operator.
Now you should see it in <code>Operators -&gt; Installed Operators</code>.</li>
</ol>
<p><img alt="" src="../images/2019-11-19-13-54-49.png" /></p>
<ol>
<li>Click on the Grafana Operator link, select <code>Grafana</code> tab and click <code>Create Grafana</code>.</li>
</ol>
<p><img alt="" src="../images/2019-11-19-13-58-23.png" /></p>
<ol>
<li>
<p>Modify the name of the Grafana instance to something meaningful. I named it <code>app-monitoring-grafana</code>. Click <code>Create</code> button. Modify also the admin user name and password.</p>
</li>
<li>
<p>Return to the Grafana Operator details, select <code>Grafana Data Source</code> and click <code>Create Grafana Data Source</code> button. Rename the <code>name:</code> to something meaningful (I named it <code>app-monitoring-grafana-datasource</code>) and modify spec.datasources.url to your app monitoring prometheus instance. In my case it was <code>http://prometheus-operated:9090</code>. </p>
</li>
</ol>
<p><img alt="" src="../images/2019-11-19-14-12-59.png" /></p>
<p>The prometheus hostname is the same as the app monitoring prometheus service name. You can find it in <code>Networking-&gt;Services</code> (filtered by the project where app monitoring prometheus has been deployed).</p>
<ol>
<li>Make the route for Grafana has been created in <code>Networking-&gt;Routes</code> (project <code>monitoring</code>). If it is not listed, create it with command:</li>
</ol>
<div class="codehilite"><pre><span></span>oc create route edge  --service<span class="o">=</span>grafana-service -n monitoring
</pre></div>


<p>Access the Grafana console URL and logon to Grafana.
Verify the Prometheus datasource has been created and can connect to app monitoring Prometheus.</p>
<ol>
<li>
<p>Import provided grafana dashboard: <code>b2m-nodejs-v2/lab-4/app-monitoring-dashboard.json</code>.</p>
</li>
<li>
<p>Verify that Grafana dashboard has been provisioned:</p>
</li>
</ol>
<p><img alt="" src="../images/2019-11-19-15-02-49.png" /></p>
<h3 id="deploy-alertmanager">Deploy Alertmanager<a class="headerlink" href="#deploy-alertmanager" title="Permanent link">&para;</a></h3>
<p>The Prometheus Operator introduces an <code>Alertmanager</code> resource, which allows users to declaratively describe an Alertmanager cluster. To successfully deploy an Alertmanager cluster, it is important to understand the contract between Prometheus and Alertmanager.</p>
<p>The Alertmanager may be used to:</p>
<ul>
<li>Deduplicate alerts fired by Prometheus</li>
<li>Silence alerts</li>
<li>Route and send grouped notifications via providers (PagerDuty, OpsGenie, Slack, Netcool Message Bus Probe, etc.)</li>
</ul>
<p>Prometheus' configuration also includes "rule files", which contain the alerting rules. When an alerting rule triggers, it fires that alert against all Alertmanager instances, on every rule evaluation interval. The Alertmanager instances communicate to each other which notifications have already been sent out.</p>
<p>In OpenShift console go to Installed Operators, click on Prometheus Operator instance, scroll tabs to Alertmanager tab.
Click <code>Create Alertmanager</code> button.</p>
<p><img alt="" src="../images/2019-11-20-11-46-42.png" /></p>
<p>Specify the desired number of replicas and click <code>Create</code> button.</p>
<p><img alt="" src="../images/2019-11-20-11-47-47.png" /></p>
<p>Now you can list the resources of Alertmanager and you should see Alertmanager pods in <code>Pending</code> state. This is because Alertmanager can't run wthout a configuration file.</p>
<p>The Alertmanager instances will not be able to start up, unless a valid configuration is given. The following example configuration sends notifications against a non-existent webhook, allowing the Alertmanager to start up, without issuing any notifications. For more information on configuring Alertmanager, see the <a href="https://prometheus.io/docs/alerting/configuration/">Prometheus Alerting Configuration</a> document.</p>
<div class="codehilite"><pre><span></span><span class="nt">global</span><span class="p">:</span>
  <span class="nt">resolve_timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="nt">route</span><span class="p">:</span>
  <span class="nt">group_by</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;job&#39;</span><span class="p p-Indicator">]</span>
  <span class="nt">group_wait</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">30s</span>
  <span class="nt">group_interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5m</span>
  <span class="nt">repeat_interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">12h</span>
  <span class="nt">receiver</span><span class="p">:</span> <span class="s">&#39;webhook&#39;</span>
<span class="nt">receivers</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;webhook&#39;</span>
  <span class="nt">webhook_configs</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">url</span><span class="p">:</span> <span class="s">&#39;http://alertmanagerwh:30500/&#39;</span>
</pre></div>


<p>Save the above Alertmanager config in a file called alertmanager.yaml and create a secret from it using <code>oc</code>.</p>
<div class="codehilite"><pre><span></span>oc create secret generic alertmanager-alertmanager-main --from-file<span class="o">=</span>alertmanager.yaml
</pre></div>


<p>Alertmanager pods should change the status to <code>Running</code>.</p>
<p><img alt="" src="../images/2019-11-20-12-03-25.png" /></p>
<p>The service <code>alertmanager-operated</code> has been created automatically and if you want to externally expose Alertmanaget UI, create the route using the followng command:</p>
<div class="codehilite"><pre><span></span>$ oc create route edge  --service<span class="o">=</span>alertmanager-operated -n monitoring
</pre></div>


<p>Collect the Alertmanager URL:</p>
<div class="codehilite"><pre><span></span> oc get routes alertmanager-operated
NAME                    HOST/PORT                                                     PATH   SERVICES                PORT   TERMINATION   WILDCARD
alertmanager-operated   alertmanager-operated-monitoring.apps.rsocp.os.fyre.ibm.com          alertmanager-operated   web    edge          None
</pre></div>


<p>and verify using web browser:</p>
<p><img alt="" src="../images/2019-11-20-12-07-34.png" /></p>
<p>This Alertmanager cluster is now fully functional and highly available, but no alerts are fired against it. Configure Prometheus resource to fire alerts to our Alertmanager cluster.</p>
<p>Edit Prometheus resource <code>spec.alerting</code> section:</p>
<div class="codehilite"><pre><span></span><span class="nt">spec</span><span class="p">:</span>
  <span class="nt">alerting</span><span class="p">:</span>
    <span class="nt">alertmanagers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">alertmanager-operated</span>
        <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">monitoring</span>
        <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
</pre></div>


<p>and click <code>Save</code>.</p>
<h3 id="configure-alerting-rules">Configure Alerting Rules<a class="headerlink" href="#configure-alerting-rules" title="Permanent link">&para;</a></h3>
<p>Alerting Rules for application monitoring can be created from the <code>Operator Details</code> view of our Prometheus Operator instance. Click on the <code>Prometheus Rule</code> tab and then on <code>Create Prometheus Rule</code> button.</p>
<p><img alt="" src="../images/2019-11-20-13-46-22.png" /></p>
<p>Specify alert rule definition in the YAML file. You can use provided ExampleAlert.yaml as an example.
<img alt="" src="../images/2020-08-17-10-41-38.png" /></p>
<p>After short time verify that your alert(s) have been activated using  Prometheus UI:</p>
<p><img alt="" src="/images/2019-11-21-15-53-47.png" /></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../monitoring/" title="3. Node.js Monitoring" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                3. Node.js Monitoring
              </span>
            </div>
          </a>
        
        
          <a href="../about/" title="About" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                About
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b41f3d20.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>