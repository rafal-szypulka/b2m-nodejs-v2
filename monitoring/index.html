



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://rafal-szypulka.github.io/b2m-nodejs-v2/monitoring/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.2.0">
    
    
      
        <title>3. Node.js Monitoring - Build to Manage - Node.js Observability</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.572ca0f0.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.8c900955.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#monitoring" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://rafal-szypulka.github.io/b2m-nodejs-v2/" title="Build to Manage - Node.js Observability" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Build to Manage - Node.js Observability
              </span>
              <span class="md-header-nav__topic">
                3. Node.js Monitoring
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/rafal-szypulka/b2m-nodejs-v2/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://rafal-szypulka.github.io/b2m-nodejs-v2/" title="Build to Manage - Node.js Observability" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Build to Manage - Node.js Observability
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/rafal-szypulka/b2m-nodejs-v2/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="1. Introduction" class="md-nav__link">
      1. Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../logging/" title="2. Node.js Logging" class="md-nav__link">
      2. Node.js Logging
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        3. Node.js Monitoring
      </label>
    
    <a href="./" title="3. Node.js Monitoring" class="md-nav__link md-nav__link--active">
      3. Node.js Monitoring
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deploy-the-monitoring-stack-in-docker-compose" title="Deploy the monitoring stack in Docker Compose" class="md-nav__link">
    Deploy the monitoring stack in Docker Compose
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instrument-application-code-with-nodejs-client-library-for-prometheus" title="Instrument application code with Node.js client library for Prometheus" class="md-nav__link">
    Instrument application code with Node.js client library for Prometheus
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#expose-default-nodejs-runtime-metrics" title="Expose default Node.js runtime metrics" class="md-nav__link">
    Expose default Node.js runtime metrics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-custom-metric" title="Define custom metric" class="md-nav__link">
    Define custom metric
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checkouts_total" title="checkouts_total" class="md-nav__link">
    checkouts_total
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http95request95duration95ms" title="http_request_duration_ms" class="md-nav__link">
    http_request_duration_ms
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metrics-collection" title="Metrics collection" class="md-nav__link">
    Metrics collection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-example-promql-queries" title="Run example PromQL queries" class="md-nav__link">
    Run example PromQL queries
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#throughput" title="Throughput" class="md-nav__link">
    Throughput
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#error-rate" title="Error rate" class="md-nav__link">
    Error rate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#request-per-minute" title="Request Per Minute" class="md-nav__link">
    Request Per Minute
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#response-time" title="Response Time" class="md-nav__link">
    Response Time
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apdex" title="Apdex" class="md-nav__link">
    Apdex
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#95th-response-time" title="95th Response Time" class="md-nav__link">
    95th Response Time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#median-response-time" title="Median Response Time" class="md-nav__link">
    Median Response Time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#average-response-time" title="Average Response Time" class="md-nav__link">
    Average Response Time
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-usage" title="Memory Usage" class="md-nav__link">
    Memory Usage
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#average-memory-usage" title="Average Memory Usage" class="md-nav__link">
    Average Memory Usage
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-prometheus-alert" title="Configure Prometheus alert" class="md-nav__link">
    Configure Prometheus alert
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-the-prometheus-datasource-in-grafana" title="Set the Prometheus datasource in Grafana" class="md-nav__link">
    Set the Prometheus datasource in Grafana
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-dashboard" title="Configure dashboard" class="md-nav__link">
    Configure dashboard
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../OCP/" title="4. Deploy to RedHat OpenShift 4.2" class="md-nav__link">
      4. Deploy to RedHat OpenShift 4.2
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/learning-distributed-tracing-101/docs/lab-jaeger-nodejs.html" title="5. Distributed Tracing labs" class="md-nav__link">
      5. Distributed Tracing labs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deploy-the-monitoring-stack-in-docker-compose" title="Deploy the monitoring stack in Docker Compose" class="md-nav__link">
    Deploy the monitoring stack in Docker Compose
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instrument-application-code-with-nodejs-client-library-for-prometheus" title="Instrument application code with Node.js client library for Prometheus" class="md-nav__link">
    Instrument application code with Node.js client library for Prometheus
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#expose-default-nodejs-runtime-metrics" title="Expose default Node.js runtime metrics" class="md-nav__link">
    Expose default Node.js runtime metrics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-custom-metric" title="Define custom metric" class="md-nav__link">
    Define custom metric
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checkouts_total" title="checkouts_total" class="md-nav__link">
    checkouts_total
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http95request95duration95ms" title="http_request_duration_ms" class="md-nav__link">
    http_request_duration_ms
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metrics-collection" title="Metrics collection" class="md-nav__link">
    Metrics collection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-example-promql-queries" title="Run example PromQL queries" class="md-nav__link">
    Run example PromQL queries
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#throughput" title="Throughput" class="md-nav__link">
    Throughput
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#error-rate" title="Error rate" class="md-nav__link">
    Error rate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#request-per-minute" title="Request Per Minute" class="md-nav__link">
    Request Per Minute
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#response-time" title="Response Time" class="md-nav__link">
    Response Time
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apdex" title="Apdex" class="md-nav__link">
    Apdex
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#95th-response-time" title="95th Response Time" class="md-nav__link">
    95th Response Time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#median-response-time" title="Median Response Time" class="md-nav__link">
    Median Response Time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#average-response-time" title="Average Response Time" class="md-nav__link">
    Average Response Time
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-usage" title="Memory Usage" class="md-nav__link">
    Memory Usage
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#average-memory-usage" title="Average Memory Usage" class="md-nav__link">
    Average Memory Usage
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-prometheus-alert" title="Configure Prometheus alert" class="md-nav__link">
    Configure Prometheus alert
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-the-prometheus-datasource-in-grafana" title="Set the Prometheus datasource in Grafana" class="md-nav__link">
    Set the Prometheus datasource in Grafana
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-dashboard" title="Configure dashboard" class="md-nav__link">
    Configure dashboard
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/rafal-szypulka/b2m-nodejs-v2/edit/master/docs/monitoring.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="monitoring">Monitoring<a class="headerlink" href="#monitoring" title="Permanent link">&para;</a></h1>
<p>One of the most important decisions to make when setting up web application monitoring is deciding on the type of metrics you need to collect about your app. The metrics you choose simplifies troubleshooting when a problem occurs and also enables you to stay on top of the stability of your services and infrastructure.</p>
<p>The <a href="https://www.weave.works/blog/the-red-method-key-metrics-for-microservices-architecture/">RED method</a> follows on the principles outlined in the <a href="https://landing.google.com/sre/book/chapters/monitoring-distributed-systems.html#xref_monitoring_golden-signals">Four Golden Signals</a>, which focuses on measuring things that end-users care about when using your web services. With the RED method, three key metrics are instrumented that monitor every microservice in your architecture:</p>
<ul>
<li>(Request) Rate - the number of requests, per second, your services are serving.</li>
<li>(Request) Errors - the number of failed requests per second.</li>
<li>(Request) Duration - The amount of time each request takes expressed as a time interval.</li>
</ul>
<p>Rate, Errors and Duration attempt to cover the most obvious web service issues. These metrics also capture an error rate that is expressed as a proportion of request rate.</p>
<p>Of course, this is just a good starting point for metrics instrumentation. Generally, the more metrics we collect from an application the better. </p>
<blockquote>
<p><strong>Instrument first, ask questions later</strong>
During development you will never know what questions you need to ask later. Software needs good instrumentation, it’s not optional. Metrics are cheap. Use them generously. The First and the most important rule, if you have to remember only one thing remember this one. Instrument all the things!</p>
<p><div style="text-align: right"> <a href="https://the-zen-of-prometheus.netlify.app/"> The Zen of Prometheus</a></div></p>
</blockquote>
<h2 id="deploy-the-monitoring-stack-in-docker-compose">Deploy the monitoring stack in Docker Compose<a class="headerlink" href="#deploy-the-monitoring-stack-in-docker-compose" title="Permanent link">&para;</a></h2>
<p>1). Start the monitoring stack:</p>
<div class="codehilite"><pre><span></span>cd b2m-nodejs-v2/lab-3
docker-compose build
docker-compose up -d
</pre></div>


<blockquote>
<p>Note, it may take a while for the first time, because it will download the monitoring stack images from DockerHub and build an image for our Node.js application.</p>
</blockquote>
<p>2). While waiting for containers, review the configuration of our monitoring lab.
- <code>b2m-nodejs-v2/lab-3/docker-compose.yaml</code> - this is the main config file for docker-compose stack which specifies all options for all containers in the stack.
- <code>b2m-nodejs-v2/lab-3/app/server.js</code> - the source code of our sample Node.js application.
- <code>b2m-nodejs-v2/lab-3/app/Dockerfile</code> - this file is used to build your app docker image.</p>
<p>3). Verify that you can access the monitoring stack UIs:
- Prometheus: <code>http://&lt;your-hostname&gt;:9090</code>
- Grafana: <code>http://&lt;your-hostname&gt;:3000</code> (user/pw: admin/foobar)</p>
<p>4). Verify that your Node.js app works:</p>
<div class="codehilite"><pre><span></span>curl http://&lt;your-hostname&gt;:3003
</pre></div>


<h2 id="instrument-application-code-with-nodejs-client-library-for-prometheus">Instrument application code with Node.js client library for Prometheus<a class="headerlink" href="#instrument-application-code-with-nodejs-client-library-for-prometheus" title="Permanent link">&para;</a></h2>
<h3 id="expose-default-nodejs-runtime-metrics">Expose default Node.js runtime metrics<a class="headerlink" href="#expose-default-nodejs-runtime-metrics" title="Permanent link">&para;</a></h3>
<p>1). Go to the directory <code>b2m-nodejs-v2/lab-3/app</code> where the <code>server.js</code> file is located and add the following dependency to the <code>package.json</code>:</p>
<div class="codehilite"><pre><span></span>    &quot;prom-client&quot;: &quot;^11.2.1&quot;
</pre></div>


<p>There are some default metrics recommended by Prometheus <a href="https://prometheus.io/docs/instrumenting/writing_clientlibs/#standard-and-runtime-collectors">itself</a>.</p>
<p>To collect these, call <code>collectDefaultMetrics</code></p>
<blockquote>
<p>Some of the metrics, concerning File Descriptors and Memory, are only available on Linux.</p>
</blockquote>
<p>In addition, some Node-specific metrics are included, such as event loop lag,
active handles and Node.js version. See what metrics there are in
<a href="https://github.com/siimon/prom-client/lib/metrics">https://github.com/siimon/prom-client/lib/metrics</a>.</p>
<p><code>collectDefaultMetrics</code> takes 1 options object with 3 entries, a timeout for how
often the probe should be fired, an optional prefix for metric names
and a registry to which metrics should be registered. By default probes are
launched every 10 seconds, but this can be modified like this:</p>
<div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;prom-client&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">collectDefaultMetrics</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">collectDefaultMetrics</span><span class="p">;</span>
<span class="c1">// Probe every 5th second.</span>
<span class="nx">collectDefaultMetrics</span><span class="p">({</span> <span class="nx">timeout</span><span class="o">:</span> <span class="mi">5000</span> <span class="p">});</span>
</pre></div>


<p>2). Edit <code>server.js</code> and <em>uncomment</em> the following lines to enable exposure of default set of Node.js metrics on standard Prometheus route <code>/metrics</code></p>
<div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">Prometheus</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;prom-client&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">metricsInterval</span> <span class="o">=</span> <span class="nx">Prometheus</span><span class="p">.</span><span class="nx">collectDefaultMetrics</span><span class="p">()</span>
</pre></div>


<p>and</p>
<div class="codehilite"><pre><span></span> <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/metrics&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
   <span class="nx">res</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="nx">Prometheus</span><span class="p">.</span><span class="nx">register</span><span class="p">.</span><span class="nx">contentType</span><span class="p">)</span>
   <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">Prometheus</span><span class="p">.</span><span class="nx">register</span><span class="p">.</span><span class="nx">metrics</span><span class="p">())</span>
 <span class="p">})</span>
</pre></div>


<p>3). Rebuild you app container</p>
<div class="codehilite"><pre><span></span>cd ~/b2m-nodejs-v2/lab-3
docker-compose down
docker-compose build
docker-compose up -d
</pre></div>


<p>Run a couple of transactions by refreshing the URL: <code>http://&lt;your-hostname&gt;:3003/checkout</code></p>
<p>Use browser or <code>curl</code> to access <code>http://&lt;your-hostname&gt;:3003/metrics</code> in order to verify exposed metrics. Output should be similar to:</p>
<div class="codehilite"><pre><span></span># HELP process_cpu_user_seconds_total Total user CPU time spent in seconds.
# TYPE process_cpu_user_seconds_total counter
process_cpu_user_seconds_total 0.028084 1546452963611

# HELP process_cpu_system_seconds_total Total system CPU time spent in seconds.
# TYPE process_cpu_system_seconds_total counter
process_cpu_system_seconds_total 0.0038780000000000004 1546452963611

# HELP process_cpu_seconds_total Total user and system CPU time spent in seconds.
# TYPE process_cpu_seconds_total counter
process_cpu_seconds_total 0.031962 1546452963611

# HELP process_start_time_seconds Start time of the process since unix epoch in seconds.
# TYPE process_start_time_seconds gauge
process_start_time_seconds 1546452953

# HELP process_resident_memory_bytes Resident memory size in bytes.
# TYPE process_resident_memory_bytes gauge
process_resident_memory_bytes 29188096 1546452963611

# HELP nodejs_eventloop_lag_seconds Lag of event loop in seconds.
# TYPE nodejs_eventloop_lag_seconds gauge
nodejs_eventloop_lag_seconds 0.000393303 1546452963612

# HELP nodejs_active_handles_total Number of active handles.
# TYPE nodejs_active_handles_total gauge
nodejs_active_handles_total 3 1546452963611

# HELP nodejs_active_requests_total Number of active requests.
# TYPE nodejs_active_requests_total gauge
nodejs_active_requests_total 0 1546452963611

# HELP nodejs_heap_size_total_bytes Process heap size from node.js in bytes.
# TYPE nodejs_heap_size_total_bytes gauge
nodejs_heap_size_total_bytes 20217856 1546452963611

# HELP nodejs_heap_size_used_bytes Process heap size used from node.js in bytes.
# TYPE nodejs_heap_size_used_bytes gauge
nodejs_heap_size_used_bytes 8464704 1546452963611

# HELP nodejs_external_memory_bytes Nodejs external memory size in bytes.
# TYPE nodejs_external_memory_bytes gauge
nodejs_external_memory_bytes 24656 1546452963611

# HELP nodejs_heap_space_size_total_bytes Process heap space size total from node.js in bytes.
# TYPE nodejs_heap_space_size_total_bytes gauge
nodejs_heap_space_size_total_bytes{space=&quot;read_only&quot;} 0 1546452963612
nodejs_heap_space_size_total_bytes{space=&quot;new&quot;} 8388608 1546452963612
nodejs_heap_space_size_total_bytes{space=&quot;old&quot;} 8134656 1546452963612
nodejs_heap_space_size_total_bytes{space=&quot;code&quot;} 1048576 1546452963612
nodejs_heap_space_size_total_bytes{space=&quot;map&quot;} 1073152 1546452963612
nodejs_heap_space_size_total_bytes{space=&quot;large_object&quot;} 1572864 1546452963612

# HELP nodejs_heap_space_size_used_bytes Process heap space size used from node.js in bytes.
# TYPE nodejs_heap_space_size_used_bytes gauge
nodejs_heap_space_size_used_bytes{space=&quot;read_only&quot;} 0 1546452963612
nodejs_heap_space_size_used_bytes{space=&quot;new&quot;} 829768 1546452963612
nodejs_heap_space_size_used_bytes{space=&quot;old&quot;} 6008448 1546452963612
nodejs_heap_space_size_used_bytes{space=&quot;code&quot;} 847136 1546452963612
nodejs_heap_space_size_used_bytes{space=&quot;map&quot;} 533016 1546452963612
nodejs_heap_space_size_used_bytes{space=&quot;large_object&quot;} 249024 1546452963612

# HELP nodejs_heap_space_size_available_bytes Process heap space size available from node.js in bytes.
# TYPE nodejs_heap_space_size_available_bytes gauge
nodejs_heap_space_size_available_bytes{space=&quot;read_only&quot;} 0 1546452963612
nodejs_heap_space_size_available_bytes{space=&quot;new&quot;} 3294904 1546452963612
nodejs_heap_space_size_available_bytes{space=&quot;old&quot;} 1656536 1546452963612
nodejs_heap_space_size_available_bytes{space=&quot;code&quot;} 0 1546452963612
nodejs_heap_space_size_available_bytes{space=&quot;map&quot;} 80 1546452963612
nodejs_heap_space_size_available_bytes{space=&quot;large_object&quot;} 1506500096 1546452963612

# HELP nodejs_version_info Node.js version info.
# TYPE nodejs_version_info gauge
nodejs_version_info{version=&quot;v10.7.0&quot;,major=&quot;10&quot;,minor=&quot;7&quot;,patch=&quot;0&quot;} 1
</pre></div>


<h3 id="define-custom-metric">Define custom metric<a class="headerlink" href="#define-custom-metric" title="Permanent link">&para;</a></h3>
<p>Node.js Prometheus client library allows to define various types of Prometheus metrics like histograms, summaries, gauges and counters. More detailed description of metric types can be found in Prometheus <a href="https://prometheus.io/docs/concepts/metric_types/">documentation</a>.</p>
<p>In this lab we will define two custom metrics:</p>
<ul>
<li>counter <code>checkouts_total</code> which will store a total number of <code>checkout</code> requests</li>
<li>histogram <code>http_request_duration_ms</code> which will store percentiles of application requests response time</li>
</ul>
<p>Uncomment the rest of commented lines in <code>server.js</code>. </p>
<h4 id="checkouts_total">checkouts_total<a class="headerlink" href="#checkouts_total" title="Permanent link">&para;</a></h4>
<p>Declaration of <code>checkouts_total</code> counter.</p>
<div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">checkoutsTotal</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Prometheus</span><span class="p">.</span><span class="nx">Counter</span><span class="p">({</span>
   <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;checkouts_total&#39;</span><span class="p">,</span>
   <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;Total number of checkouts&#39;</span><span class="p">,</span>
   <span class="nx">labelNames</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;payment_method&#39;</span><span class="p">]</span>
 <span class="p">})</span>
</pre></div>


<p>This counter will be incremented for every <code>checkout</code> request</p>
<div class="codehilite"><pre><span></span><span class="nx">checkoutsTotal</span><span class="p">.</span><span class="nx">inc</span><span class="p">({</span>
     <span class="nx">payment_method</span><span class="o">:</span> <span class="nx">paymentMethod</span>
<span class="p">})</span>
</pre></div>


<h4 id="http95request95duration95ms">http_request_duration_ms<a class="headerlink" href="#http95request95duration95ms" title="Permanent link">&para;</a></h4>
<p>Declaration of <code>http_request_duration_ms</code> histogram:</p>
<div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">httpRequestDurationMicroseconds</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Prometheus</span><span class="p">.</span><span class="nx">Histogram</span><span class="p">({</span>
   <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;http_request_duration_ms&#39;</span><span class="p">,</span>
   <span class="nx">help</span><span class="o">:</span> <span class="s1">&#39;Duration of HTTP requests in ms&#39;</span><span class="p">,</span>
   <span class="nx">labelNames</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">],</span>
   <span class="nx">buckets</span><span class="o">:</span> <span class="p">[</span><span class="mf">0.10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>  <span class="c1">// buckets for response time from 0.1ms to 500ms</span>
 <span class="p">})</span>
</pre></div>


<p>The current time is recorded before each request:</p>
<div class="codehilite"><pre><span></span><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">startEpoch</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
  <span class="nx">next</span><span class="p">()</span>
<span class="p">})</span>
</pre></div>


<p>We record the current time also after each request and update our <code>http_request_duration_ms</code> histogram accordingly:</p>
<div class="codehilite"><pre><span></span><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">responseTimeInMs</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">res</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">startEpoch</span>

  <span class="nx">httpRequestDurationMicroseconds</span>
    <span class="p">.</span><span class="nx">labels</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">route</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nx">responseTimeInMs</span><span class="p">)</span>
  <span class="nx">next</span><span class="p">()</span>
<span class="p">})</span>
</pre></div>


<p>After you complete code changes, rebuild your app container:</p>
<div class="codehilite"><pre><span></span>cd ~/b2m-nodejs-v2/lab-3
docker-compose down
docker-compose build
docker-compose up -d
</pre></div>


<p>Run a couple of transactions by refreshing the URL: <code>http://&lt;your-hostname&gt;:3003/checkout</code></p>
<p>Use browser to access <code>http://&lt;your-hostname&gt;:3003/metrics</code> to verify exposed metrics. The output should be similar to:</p>
<div class="codehilite"><pre><span></span>(...)
# HELP checkouts_total Total number of checkouts
# TYPE checkouts_total counter
checkouts_total{payment_method=&quot;paypal&quot;} 7
checkouts_total{payment_method=&quot;stripe&quot;} 5

# HELP http_request_duration_ms Duration of HTTP requests in ms
# TYPE http_request_duration_ms histogram
http_request_duration_ms_bucket{le=&quot;0.1&quot;,code=&quot;304&quot;,route=&quot;/&quot;,method=&quot;GET&quot;} 0
http_request_duration_ms_bucket{le=&quot;5&quot;,code=&quot;304&quot;,route=&quot;/&quot;,method=&quot;GET&quot;} 0
http_request_duration_ms_bucket{le=&quot;15&quot;,code=&quot;304&quot;,route=&quot;/&quot;,method=&quot;GET&quot;} 0
http_request_duration_ms_bucket{le=&quot;50&quot;,code=&quot;304&quot;,route=&quot;/&quot;,method=&quot;GET&quot;} 0
http_request_duration_ms_bucket{le=&quot;100&quot;,code=&quot;304&quot;,route=&quot;/&quot;,method=&quot;GET&quot;} 0
http_request_duration_ms_bucket{le=&quot;200&quot;,code=&quot;304&quot;,route=&quot;/&quot;,method=&quot;GET&quot;} 3
http_request_duration_ms_bucket{le=&quot;300&quot;,code=&quot;304&quot;,route=&quot;/&quot;,method=&quot;GET&quot;} 3
http_request_duration_ms_bucket{le=&quot;400&quot;,code=&quot;304&quot;,route=&quot;/&quot;,method=&quot;GET&quot;} 3
http_request_duration_ms_bucket{le=&quot;500&quot;,code=&quot;304&quot;,route=&quot;/&quot;,method=&quot;GET&quot;} 3
http_request_duration_ms_bucket{le=&quot;+Inf&quot;,code=&quot;304&quot;,route=&quot;/&quot;,method=&quot;GET&quot;} 3
http_request_duration_ms_sum{method=&quot;GET&quot;,route=&quot;/&quot;,code=&quot;304&quot;} 415
http_request_duration_ms_count{method=&quot;GET&quot;,route=&quot;/&quot;,code=&quot;304&quot;} 3
http_request_duration_ms_bucket{le=&quot;0.1&quot;,code=&quot;500&quot;,route=&quot;/bad&quot;,method=&quot;GET&quot;} 0
http_request_duration_ms_bucket{le=&quot;5&quot;,code=&quot;500&quot;,route=&quot;/bad&quot;,method=&quot;GET&quot;} 1
http_request_duration_ms_bucket{le=&quot;15&quot;,code=&quot;500&quot;,route=&quot;/bad&quot;,method=&quot;GET&quot;} 1
http_request_duration_ms_bucket{le=&quot;50&quot;,code=&quot;500&quot;,route=&quot;/bad&quot;,method=&quot;GET&quot;} 1
http_request_duration_ms_bucket{le=&quot;100&quot;,code=&quot;500&quot;,route=&quot;/bad&quot;,method=&quot;GET&quot;} 1
http_request_duration_ms_bucket{le=&quot;200&quot;,code=&quot;500&quot;,route=&quot;/bad&quot;,method=&quot;GET&quot;} 1
http_request_duration_ms_bucket{le=&quot;300&quot;,code=&quot;500&quot;,route=&quot;/bad&quot;,method=&quot;GET&quot;} 1
http_request_duration_ms_bucket{le=&quot;400&quot;,code=&quot;500&quot;,route=&quot;/bad&quot;,method=&quot;GET&quot;} 1
http_request_duration_ms_bucket{le=&quot;500&quot;,code=&quot;500&quot;,route=&quot;/bad&quot;,method=&quot;GET&quot;} 1
http_request_duration_ms_bucket{le=&quot;+Inf&quot;,code=&quot;500&quot;,route=&quot;/bad&quot;,method=&quot;GET&quot;} 1
http_request_duration_ms_sum{method=&quot;GET&quot;,route=&quot;/bad&quot;,code=&quot;500&quot;} 1
http_request_duration_ms_count{method=&quot;GET&quot;,route=&quot;/bad&quot;,code=&quot;500&quot;} 1
http_request_duration_ms_bucket{le=&quot;0.1&quot;,code=&quot;304&quot;,route=&quot;/checkout&quot;,method=&quot;GET&quot;} 8
http_request_duration_ms_bucket{le=&quot;5&quot;,code=&quot;304&quot;,route=&quot;/checkout&quot;,method=&quot;GET&quot;} 12
http_request_duration_ms_bucket{le=&quot;15&quot;,code=&quot;304&quot;,route=&quot;/checkout&quot;,method=&quot;GET&quot;} 12
http_request_duration_ms_bucket{le=&quot;50&quot;,code=&quot;304&quot;,route=&quot;/checkout&quot;,method=&quot;GET&quot;} 12
http_request_duration_ms_bucket{le=&quot;100&quot;,code=&quot;304&quot;,route=&quot;/checkout&quot;,method=&quot;GET&quot;} 12
http_request_duration_ms_bucket{le=&quot;200&quot;,code=&quot;304&quot;,route=&quot;/checkout&quot;,method=&quot;GET&quot;} 12
http_request_duration_ms_bucket{le=&quot;300&quot;,code=&quot;304&quot;,route=&quot;/checkout&quot;,method=&quot;GET&quot;} 12
http_request_duration_ms_bucket{le=&quot;400&quot;,code=&quot;304&quot;,route=&quot;/checkout&quot;,method=&quot;GET&quot;} 12
http_request_duration_ms_bucket{le=&quot;500&quot;,code=&quot;304&quot;,route=&quot;/checkout&quot;,method=&quot;GET&quot;} 12
http_request_duration_ms_bucket{le=&quot;+Inf&quot;,code=&quot;304&quot;,route=&quot;/checkout&quot;,method=&quot;GET&quot;} 12
http_request_duration_ms_sum{method=&quot;GET&quot;,route=&quot;/checkout&quot;,code=&quot;304&quot;} 4
http_request_duration_ms_count{method=&quot;GET&quot;,route=&quot;/checkout&quot;,code=&quot;304&quot;} 12
</pre></div>


<p>Besides the default set of metrics related to resource utilization by the application process, we can see the additional metrics:</p>
<ul>
<li><code>checkouts_total</code></li>
<li><code>http_request_duration_ms_bucket</code></li>
</ul>
<h2 id="metrics-collection">Metrics collection<a class="headerlink" href="#metrics-collection" title="Permanent link">&para;</a></h2>
<p>Prometheus in this lab has been pre-configured to collect metrics from your Node.js app. Check the <code>b2m-nodejs/lab-3/prometheus/prometheus.yml</code> file for this config:</p>
<div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">job_name</span><span class="p">:</span> <span class="s">&#39;b2m-nodejs&#39;</span>
  <span class="nt">scrape_interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">20s</span>
  <span class="nt">static_configs</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">targets</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;b2m-nodejs:3003&#39;</span><span class="p p-Indicator">]</span>
    <span class="nt">labels</span><span class="p">:</span>
      <span class="nt">service</span><span class="p">:</span> <span class="s">&#39;b2m-nodejs&#39;</span>
</pre></div>


<p>Verify that Prometheus server was started via: <a href="http://&lt;your-hostname&gt;:9090/graph">http://<your-hostname>:9090</a>
Check the status of scraping targets in Prometheus UI -&gt; Status -&gt; Targets </p>
<h2 id="run-example-promql-queries">Run example PromQL queries<a class="headerlink" href="#run-example-promql-queries" title="Permanent link">&para;</a></h2>
<p>Generate some application load before running the queries:</p>
<div class="codehilite"><pre><span></span>for i in {1..10000}; do curl -w &quot;\n&quot; http://localhost:3003/checkout; done
</pre></div>


<p>Run the following example PromQL queries using the Prometheus UI.</p>
<h3 id="throughput">Throughput<a class="headerlink" href="#throughput" title="Permanent link">&para;</a></h3>
<h4 id="error-rate">Error rate<a class="headerlink" href="#error-rate" title="Permanent link">&para;</a></h4>
<p>Range[0,1]: number of 5xx requests / total number of requests</p>
<div class="codehilite"><pre><span></span>sum(increase(http_request_duration_ms_count{code=~&quot;^5..$&quot;}[1m])) /  sum(increase(http_request_duration_ms_count[1m]))
</pre></div>


<p>Expected value <code>~0.2</code> because our application should return 500 for about 20% of transactions.</p>
<h4 id="request-per-minute">Request Per Minute<a class="headerlink" href="#request-per-minute" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>sum(rate(http_request_duration_ms_count[1m])) by (service, route, method, code)  * 60
</pre></div>


<p>Check the graph.</p>
<h3 id="response-time">Response Time<a class="headerlink" href="#response-time" title="Permanent link">&para;</a></h3>
<h4 id="apdex">Apdex<a class="headerlink" href="#apdex" title="Permanent link">&para;</a></h4>
<p><a href="https://en.wikipedia.org/wiki/Apdex">Apdex</a> score approximation: <code>100ms</code> target and <code>300ms</code> tolerated response time</p>
<div class="codehilite"><pre><span></span>(sum(rate(http_request_duration_ms_bucket{le=&quot;100&quot;}[1m])) by (service) + sum(rate(http_request_duration_ms_bucket{le=&quot;300&quot;}[1m])) by (service)
) / 2 / sum(rate(http_request_duration_ms_count[1m])) by (service)
</pre></div>


<blockquote>
<p>Note that we divide the sum of both buckets. The reason is that the histogram buckets are cumulative. The le="100" bucket is also contained in the le="300" bucket; dividing it by 2 corrects for that. - <a href="https://prometheus.io/docs/practices/histograms/#apdex-score">Prometheus docs</a></p>
</blockquote>
<h4 id="95th-response-time">95th Response Time<a class="headerlink" href="#95th-response-time" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>histogram_quantile(0.95, sum(rate(http_request_duration_ms_bucket[1m])) by (le, service, route, method))
</pre></div>


<h4 id="median-response-time">Median Response Time<a class="headerlink" href="#median-response-time" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>histogram_quantile(0.5, sum(rate(http_request_duration_ms_bucket[1m])) by (le, service, route, method))
</pre></div>


<h4 id="average-response-time">Average Response Time<a class="headerlink" href="#average-response-time" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>avg(rate(http_request_duration_ms_sum[1m]) / rate(http_request_duration_ms_count[1m])) by (service, route, method, code)
</pre></div>


<p><img alt="Prometheus - Data" src="../images/prometheus-data.png" /></p>
<h3 id="memory-usage">Memory Usage<a class="headerlink" href="#memory-usage" title="Permanent link">&para;</a></h3>
<h4 id="average-memory-usage">Average Memory Usage<a class="headerlink" href="#average-memory-usage" title="Permanent link">&para;</a></h4>
<p>In Megabytes.</p>
<div class="codehilite"><pre><span></span>avg(nodejs_external_memory_bytes / 1024 ) by (service)
</pre></div>


<h2 id="configure-prometheus-alert">Configure Prometheus alert<a class="headerlink" href="#configure-prometheus-alert" title="Permanent link">&para;</a></h2>
<p>Alerting rules allows to define alert conditions based on Prometheus expression language expressions and to send notifications about firing alerts to an external service. In this lab we will configure one alerting rule for median response time higher than 100ms.</p>
<p><strong>Lab instruction:</strong></p>
<p>Add the following alert rule to the <code>alert.rules</code> file. In the lab VM it is located in <code>/root/prometheus/prometheus/alert.rules</code></p>
<div class="codehilite"><pre><span></span>  - alert: APIHighMedianResponseTime
    expr: histogram_quantile(0.5, sum by(le, service, route, method) (rate(http_request_duration_ms_bucket[1m])))
      &gt; 30
    for: 1m
    annotations:
      description: &#39;{{ $labels.service }}, {{ $labels.method }} {{ $labels.route }}
        has a median response time above 100ms (current value: {{ $value }}ms)&#39;
      summary: High median response time on {{ $labels.service }} and {{ $labels.method
        }} {{ $labels.route }}
</pre></div>


<p>Restart the Prometheus stack:</p>
<div class="codehilite"><pre><span></span>cd ~/prometheus
docker-compose down
docker-compose up -d
</pre></div>


<p>Alerts can be listed via Prometheus UI: <a href="http://localhost:9090/alerts">http://localhost:9090/alerts</a></p>
<p>States of active alerts: </p>
<ul>
<li><code>pending</code>:</li>
</ul>
<p><img alt="Prometheus - Alert Pending" src="../images/prometheus-alert-pending.png" /></p>
<ul>
<li><code>firing</code>:</li>
</ul>
<p><img alt="Prometheus - Alert Firing" src="../images/prometheus-alert-firing.png" /></p>
<h2 id="set-the-prometheus-datasource-in-grafana">Set the Prometheus datasource in Grafana<a class="headerlink" href="#set-the-prometheus-datasource-in-grafana" title="Permanent link">&para;</a></h2>
<p>Logon to Grafana via <code>http://&lt;your-hostname&gt;:3000</code>
- user: admin
- password: foobar</p>
<p>Verify the prometheus datasource configuration in Grafana. If it was not already configured, <a href="http://docs.grafana.org/features/datasources/prometheus/#adding-the-data-source-to-grafana">create</a> a Grafana datasource with these settings:</p>
<ul>
<li>name: Prometheus</li>
<li>type: prometheus</li>
<li>url: http://prometheus:9090</li>
<li>Access: Server</li>
</ul>
<h2 id="configure-dashboard">Configure dashboard<a class="headerlink" href="#configure-dashboard" title="Permanent link">&para;</a></h2>
<p>Grafana Dashboard to <a href="http://docs.grafana.org/reference/export_import/#importing-a-dashboard">import</a>: <code>~/b2m-nodejs-v2/lab-3/btm-nodejs-grafana.json</code></p>
<p>Monitoring dashboard was created according to the RED Method principles:</p>
<ul>
<li>Rate (<code>Thoughput</code> and <code>Checkouts</code> panels)</li>
<li>Errors (<code>Error rate</code> panel)</li>
<li>Duration (<code>95th Response Time</code> and <code>Median Response Time</code> panels)</li>
</ul>
<p><img alt="Grafana - Throughput" src="../images/grafana.png" /></p>
<p>Review the configuration of each dashboard panel. Check the <a href="http://docs.grafana.org/reference/annotations/">annotation</a> settings.</p>
<p>Define the <a href="https://en.wikipedia.org/wiki/Apdex">Apdex</a> score chart using the following query:</p>
<div class="codehilite"><pre><span></span>(sum(rate(http_request_duration_ms_bucket{le=&quot;100&quot;}[1m])) by (service) + sum(rate(http_request_duration_ms_bucket{le=&quot;300&quot;}[1m])) by (service)
) / 2 / sum(rate(http_request_duration_ms_count[1m])) by (service)
</pre></div>


<p>You can add it to the existing dashboard:</p>
<ul>
<li>Click on the icon <code>Add panel</code> and select <code>Graph</code> panel type. </li>
<li>Click on the panel title and select edit.</li>
<li>Select <code>Prometheus</code> datasource in the <code>Metrics</code> tab of the panel query editor</li>
<li>Copy PromQL to the free form field</li>
<li>Verify the results on the panel preview</li>
<li>Explore other Graph panel options</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../logging/" title="2. Node.js Logging" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                2. Node.js Logging
              </span>
            </div>
          </a>
        
        
          <a href="../OCP/" title="4. Deploy to RedHat OpenShift 4.2" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                4. Deploy to RedHat OpenShift 4.2
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b41f3d20.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>